# Calendar Application Enhancement Guide

**Purpose**: Enable full EmailPilot Simple workflow integration with calendar review and brief generation
**Target App**: http://localhost:8000/static/calendar_master.html
**Date**: 2025-11-16
**Status**: Enhancement Recommendations

---

## Executive Summary

To support the complete EmailPilot Simple workflow (Planning â†’ Calendar Review â†’ Brief Generation), the calendar application requires **5 critical enhancements** to preserve and utilize enriched context data generated by the AI agents.

**Current State**: Calendar accepts basic event data for display and editing
**Required State**: Calendar must preserve enriched context linkage and export reviewed events with context references for final brief generation

---

## Enhancement 1: Import Metadata Support

### Current Behavior
Calendar imports events from JSON but does not capture or preserve metadata about the import source or enriched context availability.

### Required Enhancement

**Add metadata section support** to calendar import format:

```json
{
  "metadata": {
    "source": "emailpilot-simple",
    "version": "1.0",
    "generated_at": "2025-11-16T01:34:24.000Z",
    "client_id": "rogue-creamery",
    "client_name": "Rogue Creamery",
    "import_mode": "merge",

    // NEW FIELDS - Critical for enriched context linkage
    "enriched_context_available": true,
    "enriched_context_key": "rogue-creamery_2025-12-01_2025-12-31_20251116_013424",
    "enriched_context_url": "http://localhost:8001/api/enriched-context/rogue-creamery_2025-12-01_2025-12-31_20251116_013424"
  },
  "events": [...]
}
```

### Implementation Requirements

1. **UI Display** (Optional but Recommended):
   - Add metadata panel showing:
     - Source system (EmailPilot Simple)
     - Import timestamp
     - Enriched context availability indicator
     - Link to view enriched context (if API available)

2. **Data Preservation** (REQUIRED):
   - Store `enriched_context_key` in calendar session/database
   - Include `enriched_context_key` in export JSON
   - Validate enriched context linkage on import

3. **Visual Indicator** (Recommended):
   - Show badge/icon on events that have enriched context
   - Example: "ğŸ“ Enhanced" badge on event cards

### Code Changes Required

**File**: Calendar import handler (JavaScript)

```javascript
// Current import logic
function importCalendar(jsonData) {
  const events = jsonData.events || [];
  events.forEach(event => addEventToCalendar(event));
}

// ENHANCED import logic
function importCalendar(jsonData) {
  // NEW: Capture and store metadata
  if (jsonData.metadata) {
    sessionStorage.setItem('calendar_metadata', JSON.stringify(jsonData.metadata));

    // Display metadata in UI (optional)
    if (jsonData.metadata.enriched_context_available) {
      showEnrichedContextIndicator(jsonData.metadata);
    }
  }

  // Existing event import
  const events = jsonData.events || [];
  events.forEach(event => {
    // NEW: Mark events with enriched context
    if (jsonData.metadata?.enriched_context_available) {
      event._has_enriched_context = true;
      event._enriched_context_key = jsonData.metadata.enriched_context_key;
    }
    addEventToCalendar(event);
  });
}
```

---

## Enhancement 2: Event ID Preservation

### Current Behavior
Calendar may generate its own internal IDs or not preserve imported event IDs during editing.

### Required Enhancement

**Preserve event IDs** from import through export cycle.

### Implementation Requirements

1. **ID Preservation** (REQUIRED):
   - Never modify or regenerate event `id` field from import
   - If event ID missing on import, generate using EmailPilot Simple convention:
     ```javascript
     function generateEventId(event) {
       const date = event.date.split('T')[0]; // YYYY-MM-DD
       const slug = event.name.toLowerCase()
         .replace(/[^a-z0-9\s]/g, '')
         .replace(/\s+/g, '-')
         .substring(0, 50);
       return `${event.client_id || 'unknown'}-${date}-${slug}`;
     }
     ```

2. **ID Display** (Recommended):
   - Show event ID in event detail panel
   - Allow copying event ID for reference

3. **Export Validation** (REQUIRED):
   - Ensure all exported events have the same IDs as import
   - Log warning if ID changed during edit cycle

### Code Changes Required

**File**: Event creation/editing handlers

```javascript
// Current event editing
function updateEvent(eventId, updatedData) {
  const event = calendar.getEventById(eventId);
  event.setProp('title', updatedData.name);
  // ...other updates
}

// ENHANCED event editing with ID preservation
function updateEvent(eventId, updatedData) {
  const event = calendar.getEventById(eventId);

  // PRESERVE original import ID
  const originalId = event.extendedProps._original_id || eventId;

  event.setProp('title', updatedData.name);
  event.setExtendedProp('_original_id', originalId); // NEW: Track original
  event.setExtendedProp('_modified', true); // NEW: Track edits
  event.setExtendedProp('_modified_at', new Date().toISOString()); // NEW: Track when

  // ...other updates
}
```

---

## Enhancement 3: Custom Fields Support

### Current Behavior
Calendar may not display or preserve `custom_fields` object from imported events.

### Required Enhancement

**Support `custom_fields` object** for enriched data that fits within calendar spec.

### Example Custom Fields from EmailPilot Simple

```json
{
  "id": "rogue-creamery-2025-12-02-holiday-gift-guide",
  "name": "The 2025 Holiday Gift Guide",
  "date": "2025-12-02T10:17:00.000Z",
  "custom_fields": {
    "week_number": 49,
    "subject_line_b": "The Gifts They'll Actually Love - Holiday Guide 2025",
    "offer_details": "Free standard shipping on orders $75+ through December 10th",
    "secondary_message": "ğŸ Your Holiday Gift Guide just dropped!",
    "ai_generated": true,
    "planning_notes": "December kickoff - broad reach strategy"
  }
}
```

### Implementation Requirements

1. **Data Preservation** (REQUIRED):
   - Store entire `custom_fields` object without modification
   - Include in export JSON unchanged
   - Do not validate or restrict custom_fields content

2. **UI Display** (Optional):
   - Add "Custom Fields" section in event detail panel
   - Display key-value pairs in read-only format
   - Allow viewing but not editing (preserve AI-generated data)

3. **Export Inclusion** (REQUIRED):
   - Include `custom_fields` object in exported events
   - Maintain original structure and values

### Code Changes Required

**File**: Event data model

```javascript
// Current event structure
const eventData = {
  id: event.id,
  title: event.title,
  start: event.start,
  // ...standard fields
};

// ENHANCED event structure with custom_fields
const eventData = {
  id: event.id,
  title: event.title,
  start: event.start,
  // ...standard fields

  // NEW: Preserve custom_fields
  custom_fields: event.extendedProps.custom_fields || {},

  // NEW: Track modifications
  _metadata: {
    imported_at: event.extendedProps._imported_at,
    modified: event.extendedProps._modified || false,
    modified_at: event.extendedProps._modified_at,
    original_id: event.extendedProps._original_id
  }
};
```

---

## Enhancement 4: Export Format Enhancement

### Current Behavior
Calendar exports events but may not include metadata or enriched context linkage.

### Required Enhancement

**Export reviewed calendar** with full metadata and context linkage for brief generation.

### Required Export Format

```json
{
  "export_metadata": {
    "exported_at": "2025-11-16T15:30:00.000Z",
    "exported_by": "user@example.com",
    "calendar_app_version": "1.0.0",
    "review_status": "completed",

    // CRITICAL: Link back to enriched context
    "enriched_context_key": "rogue-creamery_2025-12-01_2025-12-31_20251116_013424",
    "enriched_context_url": "http://localhost:8001/api/enriched-context/rogue-creamery_2025-12-01_2025-12-31_20251116_013424",

    // Track modifications during review
    "total_events": 13,
    "modified_events": 4,
    "deleted_events": 0,
    "added_events": 0
  },

  // Original import metadata (if available)
  "import_metadata": {
    "source": "emailpilot-simple",
    "imported_at": "2025-11-16T01:34:24.000Z",
    "client_id": "rogue-creamery"
  },

  // Reviewed events
  "events": [
    {
      "id": "rogue-creamery-2025-12-02-holiday-gift-guide",
      "name": "The 2025 Holiday Gift Guide (UPDATED)",
      "date": "2025-12-02T10:00:00.000Z",
      "channel": "email",
      "type": "promotional",

      // ... all standard fields ...

      "custom_fields": {
        "week_number": 49,
        // ... preserved custom fields ...
      },

      // NEW: Modification tracking
      "_review_metadata": {
        "modified": true,
        "modified_fields": ["name", "date"],
        "modified_at": "2025-11-16T15:25:00.000Z",
        "modification_notes": "Changed send time to 10am per user request"
      }
    }
  ]
}
```

### Implementation Requirements

1. **Export Button Enhancement** (REQUIRED):
   - Add "Export for Brief Generation" button
   - Generate export JSON with all metadata
   - Prompt user for review notes/status

2. **Modification Tracking** (REQUIRED):
   - Track which events were modified
   - Track which fields were changed
   - Optional: Track reason for change

3. **Validation** (REQUIRED):
   - Ensure enriched_context_key is included
   - Verify all event IDs preserved
   - Check custom_fields preserved

### Code Changes Required

**File**: Export handler

```javascript
// Current export
function exportCalendar() {
  const events = calendar.getEvents();
  const exportData = {
    events: events.map(e => eventToJSON(e))
  };
  downloadJSON(exportData, 'calendar.json');
}

// ENHANCED export for brief generation
function exportForBriefGeneration() {
  const events = calendar.getEvents();

  // Get stored import metadata
  const importMetadata = JSON.parse(sessionStorage.getItem('calendar_metadata') || '{}');

  // Track modifications
  const modifiedEvents = events.filter(e => e.extendedProps._modified);

  const exportData = {
    export_metadata: {
      exported_at: new Date().toISOString(),
      exported_by: getCurrentUser(), // Implement user tracking
      calendar_app_version: '1.0.0',
      review_status: 'completed',

      // CRITICAL: Preserve enriched context linkage
      enriched_context_key: importMetadata.enriched_context_key,
      enriched_context_url: importMetadata.enriched_context_url,

      // Statistics
      total_events: events.length,
      modified_events: modifiedEvents.length,
      deleted_events: 0, // Track if implementing delete
      added_events: 0    // Track if implementing add new
    },

    import_metadata: {
      source: importMetadata.source,
      imported_at: importMetadata.generated_at,
      client_id: importMetadata.client_id
    },

    events: events.map(event => {
      const eventJSON = eventToJSON(event);

      // Add review metadata
      eventJSON._review_metadata = {
        modified: event.extendedProps._modified || false,
        modified_fields: event.extendedProps._modified_fields || [],
        modified_at: event.extendedProps._modified_at,
        modification_notes: event.extendedProps._modification_notes || ''
      };

      return eventJSON;
    })
  };

  downloadJSON(exportData, 'calendar_reviewed.json');
}
```

---

## Enhancement 5: Enriched Context Preview (Optional but Recommended)

### Current Behavior
Calendar only displays fields directly in the event data structure.

### Required Enhancement

**Allow viewing enriched context** for events without leaving calendar interface.

### Implementation Requirements

1. **API Integration**:
   - Call enriched context API to fetch additional details
   - Display in modal or side panel
   - Example endpoint: `GET /api/enriched-context/{context_key}/events/{event_id}`

2. **UI Components**:
   - "View Full Context" button on event details
   - Modal showing:
     - Strategic rationales
     - Complete creative brief
     - A/B test hypotheses
     - Cross-channel content
     - Planning metadata

3. **Read-Only Display**:
   - Enriched context is reference only
   - Not editable in calendar
   - Helps user understand AI reasoning during review

### Example UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event: The 2025 Holiday Gift Guide          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Date: Dec 2, 2025 10:17 AM                 â”‚
â”‚ Type: Promotional Email                     â”‚
â”‚                                             â”‚
â”‚ [Edit Event]  [View Full Context] ğŸ“       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// Click "View Full Context" â†’

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Enriched Context                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Strategic Rationale:                        â”‚
â”‚ â€¢ Send Time: Tuesday mid-morning optimal... â”‚
â”‚ â€¢ Audience: Broad reach for December...    â”‚
â”‚ â€¢ A/B Test: Emoji + offer will outperform..â”‚
â”‚                                             â”‚
â”‚ Creative Brief:                             â”‚
â”‚ â€¢ Hero Image: Overhead flat-lay of gifts...â”‚
â”‚ â€¢ Headline: The 2025 Holiday Gift Guide    â”‚
â”‚ â€¢ CTA Strategy: Primary = Shop Guide...    â”‚
â”‚                                             â”‚
â”‚ Cross-Channel:                              â”‚
â”‚ â€¢ SMS: ğŸ Your Holiday Gift Guide just...   â”‚
â”‚                                             â”‚
â”‚ [Close]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Code Changes Required

**File**: Event detail panel

```javascript
// NEW: Enriched context viewer
async function viewEnrichedContext(eventId) {
  const metadata = JSON.parse(sessionStorage.getItem('calendar_metadata') || '{}');
  const contextKey = metadata.enriched_context_key;

  if (!contextKey) {
    alert('No enriched context available for this event');
    return;
  }

  try {
    // Fetch enriched context from API or local storage
    const response = await fetch(`/api/enriched-context/${contextKey}/events/${eventId}`);
    const enrichedContext = await response.json();

    // Display in modal
    showEnrichedContextModal(enrichedContext);
  } catch (error) {
    console.error('Failed to load enriched context:', error);

    // Fallback: Try loading from local file
    const localFile = `./outputs/${contextKey}_enriched_context.json`;
    // ... implement file loading fallback
  }
}

function showEnrichedContextModal(context) {
  const modal = document.createElement('div');
  modal.className = 'enriched-context-modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h2>Enriched Context</h2>

      <section>
        <h3>Strategic Rationale</h3>
        <ul>
          <li><strong>Send Time:</strong> ${context.strategic_context.send_time_rationale || 'N/A'}</li>
          <li><strong>Audience:</strong> ${context.strategic_context.targeting_rationale || 'N/A'}</li>
          <li><strong>A/B Test:</strong> ${context.strategic_context.ab_test_hypothesis || 'N/A'}</li>
        </ul>
      </section>

      <section>
        <h3>Creative Brief</h3>
        ${formatCreativeBrief(context.creative_brief)}
      </section>

      <section>
        <h3>Cross-Channel Content</h3>
        ${formatCrossChannel(context.cross_channel_content)}
      </section>

      <button onclick="closeEnrichedContextModal()">Close</button>
    </div>
  `;

  document.body.appendChild(modal);
}
```

---

## Summary of Required Changes

### CRITICAL (Must Implement)

1. âœ… **Import metadata support** - Preserve `enriched_context_key` linkage
2. âœ… **Event ID preservation** - Never modify imported event IDs
3. âœ… **Custom fields support** - Store and export `custom_fields` object
4. âœ… **Enhanced export format** - Include metadata and modification tracking

### RECOMMENDED (Should Implement)

5. âš ï¸ **Enriched context preview** - Allow viewing AI-generated context in UI
6. âš ï¸ **Modification tracking** - Track what changed during review
7. âš ï¸ **Visual indicators** - Show which events have enriched context

### OPTIONAL (Nice to Have)

8. ğŸ“‹ **Metadata panel** - Display import metadata in UI
9. ğŸ“‹ **Event ID display** - Show event IDs in detail panel
10. ğŸ“‹ **Export validation** - Warn if enriched context linkage lost

---

## Integration Workflow

### Complete End-to-End Flow

```
1. EmailPilot Simple Generates:
   â”œâ”€ calendar_simplified.json (for calendar import)
   â”œâ”€ calendar_detailed.json (full context archive)
   â””â”€ enriched_context.json (preserved AI insights)

2. User Imports to Calendar:
   â”œâ”€ Calendar loads calendar_simplified.json
   â”œâ”€ Calendar stores enriched_context_key from metadata
   â””â”€ Events displayed with enriched context badges

3. User Reviews & Edits:
   â”œâ”€ User modifies events (dates, names, descriptions)
   â”œâ”€ Calendar tracks modifications
   â”œâ”€ User can view enriched context for reference
   â””â”€ Custom fields preserved (not editable)

4. User Exports Reviewed Calendar:
   â”œâ”€ Calendar exports calendar_reviewed.json
   â”œâ”€ Includes enriched_context_key linkage
   â”œâ”€ Includes modification tracking
   â””â”€ Preserves all custom_fields and IDs

5. EmailPilot Brief Generation:
   â”œâ”€ Loads calendar_reviewed.json (human edits)
   â”œâ”€ Loads enriched_context.json (AI insights)
   â”œâ”€ Merges both sources
   â””â”€ Generates comprehensive briefs
```

---

## Testing Checklist

### Import Testing
- [ ] Import JSON with metadata section
- [ ] Verify enriched_context_key stored
- [ ] Verify all event IDs preserved
- [ ] Verify custom_fields preserved
- [ ] Verify events display correctly

### Edit Testing
- [ ] Edit event name - verify ID unchanged
- [ ] Edit event date - verify ID unchanged
- [ ] Verify modification tracking works
- [ ] Verify custom_fields not lost during edit

### Export Testing
- [ ] Export includes export_metadata section
- [ ] Export includes enriched_context_key
- [ ] Export includes all custom_fields
- [ ] Export includes modification tracking
- [ ] Exported event IDs match imported IDs

### Integration Testing
- [ ] Import â†’ Edit â†’ Export â†’ Re-import cycle preserves all data
- [ ] Brief generation can load reviewed calendar
- [ ] Brief generation can load enriched context
- [ ] Brief generation merges correctly

---

## API Requirements (If Implementing Preview)

### Endpoint 1: Get Enriched Context

```
GET /api/enriched-context/{context_key}

Response:
{
  "enriched_context_key": "...",
  "generated_at": "...",
  "client_name": "...",
  "events": { ... }
}
```

### Endpoint 2: Get Event Enriched Context

```
GET /api/enriched-context/{context_key}/events/{event_id}

Response:
{
  "event_id": "...",
  "calendar_event_name": "...",
  "strategic_context": { ... },
  "creative_brief": { ... },
  "cross_channel_content": { ... },
  "planning_metadata": { ... }
}
```

---

## Files to Modify

### JavaScript Files
- `calendar_import.js` - Import handler enhancements
- `calendar_export.js` - Export format enhancements
- `event_handlers.js` - ID preservation and modification tracking
- `event_detail_panel.js` - Custom fields display
- `enriched_context_viewer.js` - NEW: Context preview modal

### HTML Files
- `calendar_master.html` - Add metadata panel
- `event_detail_modal.html` - Add enriched context button

### CSS Files
- `calendar_styles.css` - Add enriched context badges
- `enriched_context_modal.css` - NEW: Modal styling

---

## Migration Path

### Phase 1: Critical Data Preservation (Week 1)
- Implement metadata import/storage
- Implement event ID preservation
- Implement custom_fields preservation
- Implement enhanced export format

### Phase 2: User Experience (Week 2)
- Add enriched context badges
- Add modification tracking UI
- Add metadata display panel
- Test complete workflow

### Phase 3: Advanced Features (Week 3)
- Implement enriched context preview modal
- Add API integration for context loading
- Add export validation warnings
- User testing and refinement

---

## Success Criteria

âœ… **Data Integrity**: All imported data preserved through export cycle
âœ… **Context Linkage**: Enriched context key maintained in exports
âœ… **ID Stability**: Event IDs never change during editing
âœ… **Modification Tracking**: Can identify which events were edited
âœ… **Brief Generation**: Exported data successfully merges with enriched context

---

## Questions for Calendar App Developers

1. **Current ID handling**: Does calendar generate its own IDs or preserve imported IDs?
2. **Custom fields**: Are custom_fields objects currently supported and preserved?
3. **Export format**: Is export format customizable or fixed?
4. **API availability**: Can we add API endpoints for enriched context retrieval?
5. **User tracking**: Is there user authentication for tracking who reviewed?
6. **Versioning**: How are calendar app versions tracked?

---

## Contact

For questions about this enhancement guide, contact EmailPilot Simple development team or create implementation tickets based on the phases outlined above.
