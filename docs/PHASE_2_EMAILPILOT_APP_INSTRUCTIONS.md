# Phase 2: EmailPilot-App Backend Implementation
## Strategy Summary Integration Instructions

**Date Created:** 2025-11-18
**Target System:** emailpilot-app (FastAPI Backend)
**Prerequisite:** Phase 1 Complete (emailpilot-simple modifications)
**Implemented By:** Backend Development Team / LLM Assistant

---

## Overview

This document provides complete implementation instructions for integrating Strategy Summary functionality into the emailpilot-app FastAPI backend. Phase 1 has already modified emailpilot-simple to extract, save, and transmit strategy_summary data. Phase 2 adds backend support to receive, validate, store, and serve this data.

## What is Strategy Summary?

Strategy Summary is a high-level marketing strategy overview generated by Claude Sonnet 4.5 during calendar creation in Stage 2. It provides:
- **Key Insights** (list): Top strategic recommendations for the campaign period
- **Targeting Approach** (string): Audience segmentation and targeting strategy
- **Timing Strategy** (string): Send time optimization and cadence recommendations
- **Content Strategy** (string): Content themes, messaging, and creative direction

This data is sent from emailpilot-simple via the import script to the `/api/calendar/create-bulk-events` endpoint and must be stored in Firestore alongside calendar events.

---

## Implementation Checklist

- [ ] 1. Create `StrategySummary` Pydantic model
- [ ] 2. Update `BulkEventsCreate` Pydantic model to include optional `strategy_summary`
- [ ] 3. Modify `/api/calendar/create-bulk-events` endpoint handler
- [ ] 4. Update Firestore storage logic to save strategy_summary
- [ ] 5. Create endpoint to retrieve strategy_summary for a client/date range
- [ ] 6. Add validation and error handling
- [ ] 7. Write unit tests
- [ ] 8. Write integration tests
- [ ] 9. Update API documentation

---

## 1. Pydantic Model Changes

### File: `app/schemas/calendar.py` (or appropriate schema file)

Create a new `StrategySummary` Pydantic model matching the structure generated by Claude Sonnet 4.5:

```python
from pydantic import BaseModel, Field
from typing import List, Optional


class StrategySummary(BaseModel):
    """Strategy summary generated by Claude Sonnet 4.5 during calendar creation.

    This high-level overview provides strategic context for the calendar period,
    including key insights, targeting approach, timing strategy, and content direction.
    """
    key_insights: List[str] = Field(
        ...,
        description="Top 3-5 strategic insights and recommendations for the campaign period"
    )
    targeting_approach: str = Field(
        ...,
        description="Audience segmentation and targeting strategy for the calendar"
    )
    timing_strategy: str = Field(
        ...,
        description="Send time optimization and campaign cadence recommendations"
    )
    content_strategy: str = Field(
        ...,
        description="Content themes, messaging approach, and creative direction"
    )

    class Config:
        json_schema_extra = {
            "example": {
                "key_insights": [
                    "Focus on cheese pairing education to drive premium SKU sales",
                    "Leverage seasonal winter themes for January content",
                    "Emphasize gift boxes and subscription bundles post-holiday"
                ],
                "targeting_approach": "Segment by purchase history: VIP customers get exclusive previews, occasional buyers receive re-engagement offers, and new subscribers see product education content",
                "timing_strategy": "Tuesday/Thursday sends at 10 AM PST for optimal open rates. Weekly cadence with strategic Friday sends for weekend purchase intent",
                "content_strategy": "Educational content on cheese varieties and pairings, seasonal recipes, behind-the-scenes farm stories, and exclusive member offers"
            }
        }
```

### Update `BulkEventsCreate` Model

Modify the existing `BulkEventsCreate` model to include an optional `strategy_summary` field:

```python
class BulkEventsCreate(BaseModel):
    """Request model for bulk calendar event creation."""
    client_id: str = Field(..., description="Client identifier (e.g., 'rogue-creamery')")
    events: List[CalendarEvent] = Field(..., description="List of calendar events to create")
    strategy_summary: Optional[StrategySummary] = Field(
        None,
        description="Optional strategy summary for the calendar period (generated by Claude Sonnet 4.5)"
    )

    class Config:
        json_schema_extra = {
            "example": {
                "client_id": "rogue-creamery",
                "events": [...],  # existing event examples
                "strategy_summary": {
                    # StrategySummary example
                }
            }
        }
```

---

## 2. API Endpoint Modifications

### File: `app/api/calendar.py` (or appropriate router file)

Modify the `/api/calendar/create-bulk-events` endpoint handler to accept and process strategy_summary:

```python
from app.schemas.calendar import BulkEventsCreate, StrategySummary
from google.cloud import firestore
import logging

logger = logging.getLogger(__name__)


@router.post("/create-bulk-events")
async def create_bulk_events(
    bulk_request: BulkEventsCreate,
    db = Depends(get_db)
) -> dict:
    """Create multiple calendar events in a single request.

    Now supports optional strategy_summary field for storing high-level
    marketing strategy generated by Claude Sonnet 4.5.

    Args:
        bulk_request: BulkEventsCreate payload with events and optional strategy_summary
        db: Firestore database instance

    Returns:
        dict: Response with created event count and sample events
    """
    client_id = bulk_request.client_id
    events = bulk_request.events
    strategy_summary = bulk_request.strategy_summary

    logger.info(f"Creating {len(events)} events for client: {client_id}")

    if strategy_summary:
        logger.info(f"Strategy summary included with {len(strategy_summary.key_insights)} insights")

    # Validate client exists (existing logic)
    client_ref = db.collection("clients").document(client_id)
    client_doc = client_ref.get()

    if not client_doc.exists:
        raise HTTPException(
            status_code=404,
            detail=f"Client not found: {client_id}"
        )

    # Create events (existing logic)
    created_events = []
    batch = db.batch()

    for event_data in events:
        event_ref = db.collection("calendar_events").document()
        event_dict = event_data.dict()
        event_dict["created_at"] = firestore.SERVER_TIMESTAMP
        event_dict["updated_at"] = firestore.SERVER_TIMESTAMP

        batch.set(event_ref, event_dict)
        created_events.append({
            "id": event_ref.id,
            **event_dict
        })

    # MODIFICATION: Store strategy_summary if provided
    if strategy_summary:
        # Determine date range from events
        event_dates = [event.event_date for event in events if event.event_date]
        start_date = min(event_dates) if event_dates else None
        end_date = max(event_dates) if event_dates else None

        # Create strategy_summary document
        summary_ref = db.collection("strategy_summaries").document()
        summary_dict = {
            "client_id": client_id,
            "start_date": start_date,
            "end_date": end_date,
            "key_insights": strategy_summary.key_insights,
            "targeting_approach": strategy_summary.targeting_approach,
            "timing_strategy": strategy_summary.timing_strategy,
            "content_strategy": strategy_summary.content_strategy,
            "created_at": firestore.SERVER_TIMESTAMP,
            "updated_at": firestore.SERVER_TIMESTAMP,
            "generated_by": "claude-sonnet-4-5-20250929",
            "event_count": len(events)
        }

        batch.set(summary_ref, summary_dict)
        logger.info(f"Saving strategy summary for {client_id} ({start_date} to {end_date})")

    # Commit batch
    batch.commit()

    logger.info(f"✓ Created {len(created_events)} events for {client_id}")
    if strategy_summary:
        logger.info(f"✓ Saved strategy summary for {client_id}")

    return {
        "client_id": client_id,
        "count": len(created_events),
        "events": created_events[:5],  # Return first 5 as sample
        "has_strategy_summary": strategy_summary is not None
    }
```

---

## 3. Firestore Schema Changes

### Collection: `strategy_summaries` (NEW)

Create a new Firestore collection to store strategy summaries separately from events for easier querying and retrieval.

**Document Structure:**

```javascript
{
  "client_id": "rogue-creamery",           // string
  "start_date": "2026-01-01",              // string (ISO date)
  "end_date": "2026-01-31",                // string (ISO date)
  "key_insights": [                        // array of strings
    "Focus on cheese pairing education...",
    "Leverage seasonal winter themes...",
    "Emphasize gift boxes and subscriptions..."
  ],
  "targeting_approach": "Segment by purchase history...",  // string
  "timing_strategy": "Tuesday/Thursday sends at 10 AM...", // string
  "content_strategy": "Educational content on varieties...", // string
  "created_at": Timestamp,                 // Firestore server timestamp
  "updated_at": Timestamp,                 // Firestore server timestamp
  "generated_by": "claude-sonnet-4-5-20250929",  // string (model identifier)
  "event_count": 24                        // number (events in this calendar)
}
```

**Indexing Requirements:**

Create composite indexes in Firestore for efficient queries:

1. **Client + Date Range Query:**
   - Collection: `strategy_summaries`
   - Fields: `client_id` (Ascending), `start_date` (Ascending)
   - Query scope: Collection

2. **Client + Timestamp Query:**
   - Collection: `strategy_summaries`
   - Fields: `client_id` (Ascending), `created_at` (Descending)
   - Query scope: Collection

**Firestore Console Commands:**

```bash
# Create indexes via gcloud CLI
gcloud firestore indexes composite create \
  --collection-group=strategy_summaries \
  --field-config=field-path=client_id,order=ascending \
  --field-config=field-path=start_date,order=ascending

gcloud firestore indexes composite create \
  --collection-group=strategy_summaries \
  --field-config=field-path=client_id,order=ascending \
  --field-config=field-path=created_at,order=descending
```

---

## 4. Retrieval Endpoint (NEW)

### File: `app/api/calendar.py`

Create a new endpoint to retrieve strategy summaries for display in the UI:

```python
@router.get("/strategy-summary/{client_id}")
async def get_strategy_summary(
    client_id: str,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None,
    db = Depends(get_db)
) -> dict:
    """Retrieve strategy summary for a client and date range.

    Args:
        client_id: Client identifier (e.g., 'rogue-creamery')
        start_date: Optional start date filter (ISO format: YYYY-MM-DD)
        end_date: Optional end date filter (ISO format: YYYY-MM-DD)
        db: Firestore database instance

    Returns:
        dict: Strategy summary data or 404 if not found
    """
    query = db.collection("strategy_summaries").where("client_id", "==", client_id)

    if start_date:
        query = query.where("start_date", "==", start_date)

    if end_date:
        query = query.where("end_date", "==", end_date)

    # Order by most recent
    query = query.order_by("created_at", direction=firestore.Query.DESCENDING).limit(1)

    results = list(query.stream())

    if not results:
        raise HTTPException(
            status_code=404,
            detail=f"No strategy summary found for {client_id}"
        )

    doc = results[0]
    summary_data = doc.to_dict()
    summary_data["id"] = doc.id

    logger.info(f"Retrieved strategy summary for {client_id}: {doc.id}")

    return summary_data
```

---

## 5. Validation and Error Handling

### Validation Rules:

1. **StrategySummary Validation:**
   - `key_insights`: Must be a non-empty list (min 1 item, max 10 items)
   - `targeting_approach`: Must be non-empty string (min 10 chars, max 2000 chars)
   - `timing_strategy`: Must be non-empty string (min 10 chars, max 2000 chars)
   - `content_strategy`: Must be non-empty string (min 10 chars, max 2000 chars)

2. **BulkEventsCreate Validation:**
   - `strategy_summary` is optional
   - If provided, must pass StrategySummary validation

### Enhanced Pydantic Model with Validation:

```python
from pydantic import BaseModel, Field, validator
from typing import List


class StrategySummary(BaseModel):
    key_insights: List[str] = Field(
        ...,
        min_items=1,
        max_items=10,
        description="Top 3-5 strategic insights and recommendations"
    )
    targeting_approach: str = Field(
        ...,
        min_length=10,
        max_length=2000,
        description="Audience segmentation and targeting strategy"
    )
    timing_strategy: str = Field(
        ...,
        min_length=10,
        max_length=2000,
        description="Send time optimization and cadence recommendations"
    )
    content_strategy: str = Field(
        ...,
        min_length=10,
        max_length=2000,
        description="Content themes, messaging approach, and creative direction"
    )

    @validator('key_insights')
    def validate_insights(cls, v):
        if not v:
            raise ValueError("key_insights cannot be empty")

        for insight in v:
            if not insight or len(insight.strip()) < 10:
                raise ValueError("Each insight must be at least 10 characters")

        return v
```

### Error Response Examples:

```python
# Missing required field
{
    "detail": [
        {
            "loc": ["body", "strategy_summary", "targeting_approach"],
            "msg": "field required",
            "type": "value_error.missing"
        }
    ]
}

# Validation failure
{
    "detail": [
        {
            "loc": ["body", "strategy_summary", "key_insights"],
            "msg": "ensure this value has at least 1 items",
            "type": "value_error.list.min_items"
        }
    ]
}
```

---

## 6. Testing Requirements

### Unit Tests

**File:** `tests/test_calendar_api.py`

```python
import pytest
from app.schemas.calendar import StrategySummary, BulkEventsCreate


def test_strategy_summary_valid():
    """Test valid StrategySummary model."""
    summary = StrategySummary(
        key_insights=[
            "Focus on premium SKU sales",
            "Leverage seasonal themes",
            "Emphasize subscriptions"
        ],
        targeting_approach="Segment by purchase history: VIP vs occasional buyers",
        timing_strategy="Tuesday/Thursday at 10 AM PST for optimal engagement",
        content_strategy="Educational content, seasonal recipes, farm stories"
    )

    assert len(summary.key_insights) == 3
    assert "premium SKU" in summary.key_insights[0]
    assert len(summary.targeting_approach) > 10


def test_strategy_summary_empty_insights():
    """Test that empty insights list raises validation error."""
    with pytest.raises(ValueError, match="key_insights cannot be empty"):
        StrategySummary(
            key_insights=[],
            targeting_approach="Valid approach",
            timing_strategy="Valid strategy",
            content_strategy="Valid content"
        )


def test_strategy_summary_short_insight():
    """Test that short insights raise validation error."""
    with pytest.raises(ValueError, match="at least 10 characters"):
        StrategySummary(
            key_insights=["Short"],
            targeting_approach="Valid approach",
            timing_strategy="Valid strategy",
            content_strategy="Valid content"
        )


def test_bulk_events_with_strategy_summary():
    """Test BulkEventsCreate with strategy_summary."""
    request = BulkEventsCreate(
        client_id="rogue-creamery",
        events=[],  # Simplified for test
        strategy_summary=StrategySummary(
            key_insights=["Insight 1", "Insight 2", "Insight 3"],
            targeting_approach="Segment by purchase history",
            timing_strategy="Tuesday/Thursday sends",
            content_strategy="Educational content"
        )
    )

    assert request.strategy_summary is not None
    assert len(request.strategy_summary.key_insights) == 3


def test_bulk_events_without_strategy_summary():
    """Test BulkEventsCreate without strategy_summary (backward compatible)."""
    request = BulkEventsCreate(
        client_id="rogue-creamery",
        events=[]
    )

    assert request.strategy_summary is None
```

### Integration Tests

**File:** `tests/integration/test_calendar_workflow.py`

```python
import pytest
from fastapi.testclient import TestClient
from app.main import app


client = TestClient(app)


def test_create_bulk_events_with_strategy_summary(test_db):
    """Test full workflow: create events with strategy summary."""

    payload = {
        "client_id": "test-client",
        "events": [
            {
                "client_id": "test-client",
                "title": "Test Campaign",
                "content": "Campaign description",
                "event_date": "2026-01-15",
                "event_type": "promotional",
                "send_time": "10:00 AM",
                "color": "bg-red-100 text-red-800"
            }
        ],
        "strategy_summary": {
            "key_insights": [
                "Test insight 1",
                "Test insight 2",
                "Test insight 3"
            ],
            "targeting_approach": "Test targeting approach with sufficient length",
            "timing_strategy": "Test timing strategy with sufficient length",
            "content_strategy": "Test content strategy with sufficient length"
        }
    }

    response = client.post("/api/calendar/create-bulk-events", json=payload)

    assert response.status_code == 200
    data = response.json()
    assert data["client_id"] == "test-client"
    assert data["count"] == 1
    assert data["has_strategy_summary"] is True

    # Verify strategy_summary saved to Firestore
    summaries = test_db.collection("strategy_summaries") \
        .where("client_id", "==", "test-client") \
        .stream()

    summary_list = list(summaries)
    assert len(summary_list) == 1

    summary_data = summary_list[0].to_dict()
    assert summary_data["client_id"] == "test-client"
    assert len(summary_data["key_insights"]) == 3
    assert summary_data["targeting_approach"] == "Test targeting approach with sufficient length"


def test_retrieve_strategy_summary(test_db):
    """Test retrieving strategy summary by client and date."""

    # Create test data
    test_db.collection("strategy_summaries").add({
        "client_id": "test-client",
        "start_date": "2026-01-01",
        "end_date": "2026-01-31",
        "key_insights": ["Insight 1", "Insight 2"],
        "targeting_approach": "Test approach",
        "timing_strategy": "Test timing",
        "content_strategy": "Test content",
        "created_at": firestore.SERVER_TIMESTAMP
    })

    # Retrieve
    response = client.get(
        "/api/calendar/strategy-summary/test-client",
        params={"start_date": "2026-01-01", "end_date": "2026-01-31"}
    )

    assert response.status_code == 200
    data = response.json()
    assert data["client_id"] == "test-client"
    assert len(data["key_insights"]) == 2
    assert "id" in data


def test_backward_compatibility_no_strategy_summary(test_db):
    """Test that bulk create works without strategy_summary (backward compatible)."""

    payload = {
        "client_id": "test-client",
        "events": [
            {
                "client_id": "test-client",
                "title": "Test Campaign",
                "content": "Campaign description",
                "event_date": "2026-01-15",
                "event_type": "promotional",
                "send_time": "10:00 AM",
                "color": "bg-red-100 text-red-800"
            }
        ]
        # NO strategy_summary field
    }

    response = client.post("/api/calendar/create-bulk-events", json=payload)

    assert response.status_code == 200
    data = response.json()
    assert data["has_strategy_summary"] is False
```

---

## 7. API Documentation Updates

### OpenAPI Schema Updates

The FastAPI auto-generated docs at `/docs` will automatically update when you add the Pydantic models. Ensure the following are visible:

1. **POST `/api/calendar/create-bulk-events`**
   - Request body includes optional `strategy_summary` field
   - Response includes `has_strategy_summary` boolean

2. **GET `/api/calendar/strategy-summary/{client_id}`**
   - Path parameter: `client_id`
   - Query parameters: `start_date`, `end_date`
   - Response: StrategySummary object with metadata

### Manual Documentation

Update any separate API documentation (e.g., README, Postman collections, Swagger annotations) to include:

**Example Request with Strategy Summary:**

```json
POST /api/calendar/create-bulk-events
{
  "client_id": "rogue-creamery",
  "events": [...],
  "strategy_summary": {
    "key_insights": [
      "Focus on cheese pairing education to drive premium SKU sales",
      "Leverage seasonal winter themes for January content",
      "Emphasize gift boxes and subscription bundles post-holiday"
    ],
    "targeting_approach": "Segment by purchase history: VIP customers get exclusive previews, occasional buyers receive re-engagement offers, and new subscribers see product education content",
    "timing_strategy": "Tuesday/Thursday sends at 10 AM PST for optimal open rates. Weekly cadence with strategic Friday sends for weekend purchase intent",
    "content_strategy": "Educational content on cheese varieties and pairings, seasonal recipes, behind-the-scenes farm stories, and exclusive member offers"
  }
}
```

**Example Response:**

```json
{
  "client_id": "rogue-creamery",
  "count": 24,
  "events": [...],
  "has_strategy_summary": true
}
```

---

## 8. Deployment Considerations

### Environment Variables

No new environment variables required. Uses existing Firestore configuration.

### Database Migrations

1. Create `strategy_summaries` collection (auto-created on first write)
2. Create composite indexes (see Firestore Schema section)
3. No migration needed for existing data (backward compatible)

### Rollback Plan

If issues arise:
1. Feature is optional - system works without strategy_summary
2. Remove `strategy_summary` field from `BulkEventsCreate` model
3. Comment out strategy_summary storage logic in endpoint
4. Delete `strategy_summaries` collection if needed

### Monitoring

Add logging for:
- Strategy summary creation success/failure
- Strategy summary retrieval requests
- Validation errors
- Firestore write performance

**Example Log Messages:**

```
INFO: Strategy summary included with 3 insights
INFO: Saving strategy summary for rogue-creamery (2026-01-01 to 2026-01-31)
INFO: ✓ Saved strategy summary for rogue-creamery
INFO: Retrieved strategy summary for rogue-creamery: abc123xyz
WARNING: Strategy summary validation failed: key_insights cannot be empty
```

---

## 9. Implementation Order

Follow this sequence to minimize errors:

1. ✅ Create `StrategySummary` Pydantic model
2. ✅ Update `BulkEventsCreate` model with optional field
3. ✅ Write unit tests for models
4. ✅ Modify `/api/calendar/create-bulk-events` endpoint
5. ✅ Test manually with Postman/curl
6. ✅ Create Firestore indexes
7. ✅ Implement retrieval endpoint
8. ✅ Write integration tests
9. ✅ Update API documentation
10. ✅ Deploy to staging
11. ✅ Run end-to-end test from emailpilot-simple import
12. ✅ Deploy to production

---

## 10. Success Criteria

Phase 2 is complete when:

- ✅ `StrategySummary` Pydantic model created and validated
- ✅ `/api/calendar/create-bulk-events` accepts and stores strategy_summary
- ✅ Firestore `strategy_summaries` collection created with proper indexes
- ✅ `/api/calendar/strategy-summary/{client_id}` retrieval endpoint working
- ✅ All unit tests passing
- ✅ All integration tests passing
- ✅ Import script from emailpilot-simple successfully transmits data
- ✅ Strategy summary visible in Firestore console
- ✅ API documentation updated
- ✅ No breaking changes to existing functionality

---

## Questions or Issues?

If you encounter problems during implementation:

1. Check that Phase 1 is complete (emailpilot-simple modifications)
2. Verify import script is using latest version (includes strategy_summary)
3. Check Firestore permissions and indexes
4. Review validation error messages for schema mismatches
5. Verify Claude Sonnet 4.5 model is generating strategy_summary in Stage 2

For technical support, refer to:
- `/emailpilot-simple/docs/STRATEGY_SUMMARY_TECHNICAL_SPEC.md`
- This document
- Phase 3 instructions (frontend integration)

---

**Document Version:** 1.0
**Last Updated:** 2025-11-18
**Next Phase:** Phase 3 - Calendar Frontend Integration
